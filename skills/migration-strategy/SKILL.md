---
name: migration-strategy
category: dev
description: "DB 마이그레이션 시 expand-contract 패턴 강제, zero-downtime 컬럼 변경 의무화, rollback 게이트, 데이터 무결성 검증"
user-invocable: true
allowed-tools:
  - Read
  - Write
  - Edit
  - Glob
  - Grep
  - Bash
  - WebSearch
---

# 마이그레이션 전략 워크플로우 (Migration Strategy)

> 스키마를 변경하기 전에 rollback 계획을 먼저 세운다. Zero-downtime 보장 없이 마이그레이션을 실행하지 않는다.

## 게이트 (반드시 먼저)

마이그레이션을 작성하거나 실행하기 전에 반드시 완료해야 하는 선행 조건.
통과하지 않으면 다음 단계로 진행하지 않는다.

- [ ] 변경 대상 테이블의 현재 스키마와 데이터 크기(행 수) 파악 완료
- [ ] 현재 프로덕션에서 해당 테이블을 참조하는 쿼리·인덱스·외래키 목록화 완료
- [ ] 변경이 **파괴적(destructive)** 인지 판단: 컬럼 삭제, 타입 변경, NOT NULL 추가, 테이블 이름 변경
- [ ] 파괴적 변경이면 **expand-contract 패턴** 적용 여부 결정 (단일 마이그레이션 금지)
- [ ] rollback 마이그레이션(down)이 작성 가능한지 확인 — 불가능하면 접근 방식 재검토

## 규칙 (항상 따라야 함)

1. **Expand-Contract 패턴 강제**: 파괴적 변경은 반드시 2단계 이상으로 분리한다. ① Expand: 새 컬럼/테이블 추가 + 이중 쓰기 → ② Contract: 구 컬럼/테이블 제거. 한 번의 마이그레이션으로 컬럼 삭제+추가를 동시에 하지 않는다.
2. **컬럼 삭제 = 최소 2단계**: ① 코드에서 해당 컬럼 참조 제거 + 배포 → ② 확인 후 컬럼 삭제 마이그레이션 실행. 코드가 아직 참조하는 컬럼을 삭제하지 않는다.
3. **NOT NULL 추가 = 3단계**: ① nullable 컬럼 추가 → ② 기존 데이터 백필(backfill) → ③ NOT NULL 제약 추가. 데이터가 있는 테이블에 NOT NULL 컬럼을 직접 추가하지 않는다.
4. **대용량 테이블 잠금 방지**: 100만 행 이상 테이블은 `ALTER TABLE`의 잠금 영향을 분석한다. PostgreSQL에서 `ALTER TABLE ... ADD COLUMN` (default 없음)은 안전하지만 `ADD COLUMN ... DEFAULT x`는 전체 테이블 재작성 유발 가능 (PG 11 이전).
5. **Rollback 마이그레이션 필수**: 모든 마이그레이션에 `down()` 함수를 작성한다. rollback이 불가능한 마이그레이션은 별도로 표시하고 팀 리뷰를 거친다.
6. **데이터 백필은 배치로**: 대량 데이터 업데이트는 한 번의 UPDATE 대신 배치(1000-10000행)로 분할 실행한다. 트랜잭션 크기를 제한하여 잠금과 WAL 사이즈를 관리한다.
7. **인덱스는 CONCURRENTLY**: PostgreSQL에서 인덱스 생성 시 `CREATE INDEX CONCURRENTLY`를 사용한다. 일반 `CREATE INDEX`는 테이블 쓰기 잠금을 유발한다.
8. **마이그레이션 테스트 의무**: 프로덕션 데이터 스냅샷(또는 대표 샘플)에서 마이그레이션을 먼저 실행하고 검증한다. 빈 DB에서만 테스트하지 않는다.

## 완료 체크리스트 (통과해야 완료)

작업 완료 전 반드시 확인. 하나라도 실패하면 완료 아님.

- [ ] 파괴적 변경이 expand-contract 패턴으로 분리되었는가
- [ ] 모든 마이그레이션에 rollback(down) 함수가 작성되었는가
- [ ] 대용량 테이블(100만+ 행)에 대해 잠금 영향 분석이 완료되었는가
- [ ] 인덱스가 `CONCURRENTLY` 옵션으로 생성되었는가
- [ ] 데이터 백필이 배치 처리로 구현되었는가
- [ ] 프로덕션 유사 환경에서 마이그레이션이 성공적으로 실행되었는가
- [ ] 애플리케이션 코드가 마이그레이션 전·후 스키마 모두에서 동작하는가 (무중단)
- [ ] 마이그레이션 실행 후 데이터 무결성(행 수, NULL 값, 참조 무결성)이 유지되는가
